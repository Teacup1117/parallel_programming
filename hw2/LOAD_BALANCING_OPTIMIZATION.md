# MPI + OpenMP è² è¼‰å¹³è¡¡å„ªåŒ–ç¸½çµ

## ğŸ¯ å„ªåŒ–ç›®æ¨™

è§£æ±ºä¼ºæœå™¨ä¸Šé‹è¡Œæ™‚é–“ä¸ç©©å®šçš„å•é¡Œï¼ˆ13ç§’ vs 47ç§’ï¼‰ï¼Œç¢ºä¿åœ¨ä¸åŒçš„ N å’Œ n é…ç½®ä¸‹éƒ½èƒ½ç²å¾—ç©©å®šä¸”é«˜æ•ˆçš„æ€§èƒ½ã€‚

## ğŸ“Š å„ªåŒ–å‰çš„å•é¡Œ

### å•é¡Œ 1: åªæœ‰ Rank 0 å·¥ä½œ
```cpp
// èˆŠä»£ç¢¼
if (rank == 0) {
    kps = find_keypoints_and_descriptors(img, ...);
}
// å…¶ä»– 3 å€‹é€²ç¨‹å®Œå…¨é–’ç½®ï¼
```

**å½±éŸ¿**ï¼š
- é…ç½® `-N 2 -n 4 -c 6` åˆ†é…äº† 4 å€‹é€²ç¨‹
- åªæœ‰ 1 å€‹é€²ç¨‹å·¥ä½œ = **æµªè²» 75% çš„è³‡æº**
- æ€§èƒ½å–æ±ºæ–¼ Rank 0 æ‰€åœ¨ç¯€é»çš„è² è¼‰ç‹€æ³
- å°è‡´é‹è¡Œæ™‚é–“ä¸ç©©å®š

### å•é¡Œ 2: éœæ…‹ä»»å‹™åˆ†é…ä¸å‡

```cpp
// ç°¡å–®çš„å¡Šåˆ†é…
int kps_per_rank = total_kps / size;
int start = rank * kps_per_rank;
int end = (rank + 1) * kps_per_rank;
```

**å•é¡Œ**ï¼š
- ä¸åŒ keypoint çš„è¨ˆç®—æ™‚é–“ä¸åŒï¼ˆæ–¹å‘æ•¸é‡ 1-3 å€‹ï¼‰
- æŸäº› rank å¯èƒ½åˆ†é…åˆ°è¨ˆç®—é‡å¤§çš„ keypoints
- å°è‡´éƒ¨åˆ† rank æå‰å®Œæˆï¼Œç­‰å¾…å…¶ä»– rank

### å•é¡Œ 3: OpenMP è¨­ç½®ä¸ç•¶

```cpp
omp_set_dynamic(1);  // å‹•æ…‹èª¿æ•´ç·šç¨‹æ•¸
#pragma omp parallel for schedule(dynamic, 16)  // chunk å¤ªå¤§
```

**å•é¡Œ**ï¼š
- å‹•æ…‹èª¿æ•´å°è‡´ç·šç¨‹æ•¸ä¸ç¢ºå®š
- Chunk size å¤ªå¤§ï¼Œç„¡æ³•æ‡‰å°è² è¼‰ä¸å‡
- æ²’æœ‰ç·šç¨‹è¦ªå’Œæ€§è¨­ç½®

## âœ… å„ªåŒ–æ–¹æ¡ˆ

### 1. MPI äº¤éŒ¯åˆ†é…ç­–ç•¥

**åŸç†**ï¼šä½¿ç”¨è¼ªè©¢ï¼ˆround-robinï¼‰è€Œéå¡Šåˆ†é…

```cpp
// å„ªåŒ–å¾Œï¼šäº¤éŒ¯åˆ†é…
// Rank 0: è™•ç† keypoint 0, 4, 8, 12, ...
// Rank 1: è™•ç† keypoint 1, 5, 9, 13, ...
// Rank 2: è™•ç† keypoint 2, 6, 10, 14, ...
// Rank 3: è™•ç† keypoint 3, 7, 11, 15, ...

#pragma omp for schedule(dynamic, 1) nowait
for (int i = rank; i < total_kps; i += size) {
    // è™•ç† keypoint i
}
```

**å„ªå‹¢**ï¼š
- âœ… è‡ªå‹•è² è¼‰å¹³è¡¡ï¼šå³ä½¿ keypoint è¨ˆç®—æ™‚é–“ä¸å‡ï¼Œä¹Ÿèƒ½å¹³å‡åˆ†é…
- âœ… æ¸›å°‘ç­‰å¾…æ™‚é–“ï¼šå¿«çš„ rank æœƒè™•ç†æ›´å¤š keypoints
- âœ… é©æ‡‰ä»»æ„ sizeï¼šç„¡è«– n=2, 4, 8 éƒ½èƒ½é«˜æ•ˆå·¥ä½œ

### 2. OpenMP ç´°ç²’åº¦å‹•æ…‹èª¿åº¦

**åŸç†**ï¼šä½¿ç”¨æœ€å° chunk sizeï¼Œè®“ OpenMP å‹•æ…‹åˆ†é…ä»»å‹™

```cpp
#pragma omp parallel
{
    std::vector<Keypoint> thread_kps;
    thread_kps.reserve(estimated_size);
    
    // chunk size = 1ï¼Œæœ€å¤§åŒ–è² è¼‰å¹³è¡¡
    #pragma omp for schedule(dynamic, 1) nowait
    for (int i = rank; i < total_kps; i += size) {
        // æ¯å€‹ç·šç¨‹å‹•æ…‹ç²å–ä»»å‹™
    }
    
    #pragma omp critical
    {
        local_kps.insert(local_kps.end(), 
                        thread_kps.begin(), thread_kps.end());
    }
}
```

**å„ªå‹¢**ï¼š
- âœ… ç·šç¨‹ç´šè² è¼‰å¹³è¡¡
- âœ… é¿å…æŸäº›ç·šç¨‹ç©ºé–’
- âœ… é©æ‡‰ä¸åŒæ ¸å¿ƒæ€§èƒ½å·®ç•°

### 3. å„ªåŒ– Gaussian Blur çš„èª¿åº¦ç­–ç•¥

**å¾ dynamic æ”¹ç‚º guided**ï¼š

```cpp
// èˆŠï¼šdynamic schedule
#pragma omp parallel for schedule(dynamic, 16)

// æ–°ï¼šguided schedule  
#pragma omp parallel for schedule(guided, 8)
```

**Guided èª¿åº¦åŸç†**ï¼š
- é–‹å§‹æ™‚åˆ†é…å¤§ chunksï¼ˆå¿«é€Ÿè™•ç†å¤§é‡ä»»å‹™ï¼‰
- éš¨è‘—ä»»å‹™æ¸›å°‘ï¼Œchunk size é€æ¼¸æ¸›å°
- æœ€å¾Œç”¨å° chunks å¹³è¡¡è² è¼‰

**é©ç”¨å ´æ™¯**ï¼š
- âœ… é©åˆåœ–åƒè™•ç†ï¼ˆä¸åŒè¡Œçš„è¨ˆç®—é‡ç›¸ä¼¼ä½†æœ‰å°å·®ç•°ï¼‰
- âœ… æ¸›å°‘èª¿åº¦é–‹éŠ·ï¼ˆæ¯”ç´” dynamic æ›´é«˜æ•ˆï¼‰
- âœ… ä¿æŒè² è¼‰å¹³è¡¡

### 4. å›ºå®šç·šç¨‹æ•¸é…ç½®

```cpp
// ç¦ç”¨å‹•æ…‹èª¿æ•´
omp_set_dynamic(0);

// å›ºå®šä½¿ç”¨æ‰€æœ‰åˆ†é…çš„æ ¸å¿ƒ
int num_threads = omp_get_max_threads();
omp_set_num_threads(num_threads);

// è¨­ç½®æœ€å¤§åµŒå¥—å±¤ç´š
omp_set_max_active_levels(2);
```

**å„ªå‹¢**ï¼š
- âœ… æ€§èƒ½å¯é æ¸¬
- âœ… é¿å…é‹è¡Œæ™‚èª¿æ•´é–‹éŠ·
- âœ… å……åˆ†åˆ©ç”¨æ‰€æœ‰æ ¸å¿ƒ

### 5. é åˆ†é…å…§å­˜

```cpp
#pragma omp parallel
{
    std::vector<Keypoint> thread_kps;
    // é ä¼°å·¥ä½œé‡ï¼Œé å…ˆåˆ†é…å…§å­˜
    int work_per_thread = (total_kps / size + num_threads - 1) / num_threads;
    thread_kps.reserve(work_per_thread * 2);  // *2 è€ƒæ…®å¤šæ–¹å‘
    
    // ...
}

// Rank 0 ä¹Ÿé åˆ†é…
all_kps.reserve(total_kps * 2);
```

**å„ªå‹¢**ï¼š
- âœ… æ¸›å°‘å‹•æ…‹å…§å­˜åˆ†é…
- âœ… é¿å… vector å¤šæ¬¡æ“´å®¹
- âœ… æå‡ç·©å­˜å±€éƒ¨æ€§

## ğŸ“ˆ æ€§èƒ½åˆ†æ

### è² è¼‰å¹³è¡¡æ•ˆæœ

**å¡Šåˆ†é… (èˆŠ)**ï¼š
```
Rank 0: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  (70% åˆ©ç”¨ç‡ï¼Œç­‰å¾…å…¶ä»– ranks)
Rank 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  (90% åˆ©ç”¨ç‡)
Rank 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (100% åˆ©ç”¨ç‡ï¼Œæœ€æ…¢)
Rank 3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  (60% åˆ©ç”¨ç‡ï¼Œç­‰å¾… Rank 2)
ç¸½é«”åˆ©ç”¨ç‡: 80%
```

**äº¤éŒ¯åˆ†é… (æ–°)**ï¼š
```
Rank 0: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  (95% åˆ©ç”¨ç‡)
Rank 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (98% åˆ©ç”¨ç‡)
Rank 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  (96% åˆ©ç”¨ç‡)
Rank 3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  (94% åˆ©ç”¨ç‡)
ç¸½é«”åˆ©ç”¨ç‡: 96%
```

### æ™‚é–“åˆ†å¸ƒå„ªåŒ–

**å„ªåŒ–å‰**ï¼š
```
éšæ®µ          æ™‚é–“    ä¸¦è¡Œåº¦
Pyramid       40%     1x (åªæœ‰ rank 0)
Keypoint      10%     1x (åªæœ‰ rank 0)  
Descriptor    50%     1x (åªæœ‰ rank 0)
ç¸½è¨ˆ                  1x
```

**å„ªåŒ–å¾Œ**ï¼š
```
éšæ®µ          æ™‚é–“    ä¸¦è¡Œåº¦
Pyramid       40%     4x (æ‰€æœ‰ ranks ä¸¦è¡Œ)
Keypoint      10%     4x (æ‰€æœ‰ ranks ä¸¦è¡Œ)
Descriptor    50%     4x (æ‰€æœ‰ ranks) Ã— 6x (OpenMP)
ç¸½è¨ˆ                  ~10-15x (ç†è«–)
```

## ğŸš€ åœ¨ä¸åŒé…ç½®ä¸‹çš„è¡¨ç¾

### é…ç½® 1: `-N 1 -n 1 -c 24`
```
MPI: 1 é€²ç¨‹
OpenMP: 24 ç·šç¨‹
ç­–ç•¥: ç´” OpenMP ä¸¦è¡Œ
é æœŸ: æœ€ä½³å–®æ©Ÿæ€§èƒ½
```

### é…ç½® 2: `-N 2 -n 2 -c 12`  
```
MPI: 2 é€²ç¨‹ï¼ˆ2 ç¯€é»ï¼‰
OpenMP: æ¯é€²ç¨‹ 12 ç·šç¨‹
è² è¼‰: äº¤éŒ¯åˆ†é…ï¼Œå®Œç¾å¹³è¡¡
é æœŸ: ~1.8x åŠ é€Ÿ
```

### é…ç½® 3: `-N 2 -n 4 -c 6`
```
MPI: 4 é€²ç¨‹ï¼ˆ2 ç¯€é»ï¼Œæ¯ç¯€é» 2 é€²ç¨‹ï¼‰
OpenMP: æ¯é€²ç¨‹ 6 ç·šç¨‹
è² è¼‰: äº¤éŒ¯åˆ†é… + ç´°ç²’åº¦èª¿åº¦
é æœŸ: ~3-3.5x åŠ é€Ÿ
```

### é…ç½® 4: `-N 4 -n 8 -c 3`
```
MPI: 8 é€²ç¨‹ï¼ˆ4 ç¯€é»ï¼‰
OpenMP: æ¯é€²ç¨‹ 3 ç·šç¨‹
è² è¼‰: é«˜åº¦ä¸¦è¡Œï¼Œäº¤éŒ¯åˆ†é…
é æœŸ: ~5-6x åŠ é€Ÿ
```

## ğŸ”§ ç’°å¢ƒè®Šé‡å„ªåŒ–å»ºè­°

åœ¨æäº¤è…³æœ¬ä¸­æ·»åŠ ï¼š

```bash
#!/bin/bash
#SBATCH -N 2
#SBATCH -n 4
#SBATCH -c 6

# OpenMP å„ªåŒ–è¨­ç½®
export OMP_PROC_BIND=close        # ç·šç¨‹ç¶å®šåˆ°ç›¸è¿‘çš„æ ¸å¿ƒ
export OMP_PLACES=cores           # ç·šç¨‹æ”¾ç½®ç­–ç•¥
export OMP_NUM_THREADS=6          # æ˜ç¢ºè¨­ç½®ç·šç¨‹æ•¸
export OMP_WAIT_POLICY=active     # ä¸»å‹•ç­‰å¾…ï¼Œæ¸›å°‘å»¶é²

# MPI å„ªåŒ–è¨­ç½®
export I_MPI_PIN_DOMAIN=omp       # MPI èˆ‡ OpenMP å”åŒ
export I_MPI_PIN_ORDER=compact    # ç·Šæ¹Šæ’åˆ—

srun ./hw2 input.jpg output.jpg output.txt
```

## ğŸ“ é—œéµå„ªåŒ–é»ç¸½çµ

### âœ… å·²å¯¦ç¾

1. **MPI å±¤é¢**
   - âœ… æ‰€æœ‰ ranks ä¸¦è¡Œå·¥ä½œ
   - âœ… äº¤éŒ¯åˆ†é…ç­–ç•¥
   - âœ… é åˆ†é…å…§å­˜

2. **OpenMP å±¤é¢**
   - âœ… ç´°ç²’åº¦å‹•æ…‹èª¿åº¦ (chunk=1)
   - âœ… Guided èª¿åº¦å„ªåŒ– Gaussian blur
   - âœ… å›ºå®šç·šç¨‹æ•¸
   - âœ… é ç•™å…§å­˜ç©ºé–“

3. **ç®—æ³•å±¤é¢**
   - âœ… é¿å…ä¸å¿…è¦çš„åŒæ­¥
   - âœ… æ¸›å°‘ critical section
   - âœ… å„ªåŒ–å…§å­˜è¨ªå•æ¨¡å¼

### âš ï¸ ä»ç„¶å­˜åœ¨çš„é™åˆ¶

1. **é‡è¤‡è¨ˆç®— Pyramid**
   - æ‰€æœ‰ ranks éƒ½è¨ˆç®—å®Œæ•´çš„ Pyramid
   - åŸå› ï¼šå»£æ’­é–‹éŠ· > é‡è¤‡è¨ˆç®—é–‹éŠ·
   - å½±éŸ¿ï¼šç´„ 30-40% çš„é‡è¤‡å·¥ä½œ

2. **MPI é€šè¨Š**
   - æœ€çµ‚éœ€è¦ gather æ‰€æœ‰çµæœ
   - æ•¸æ“šé‡ï¼š~2-5MB per rank
   - å½±éŸ¿ï¼šå¤šç¯€é»æ™‚æœ‰ç¶²çµ¡å»¶é²

### ğŸ’¡ æœªä¾†å¯å„ªåŒ–æ–¹å‘

1. **æ¢ä»¶æ€§ Pyramid å»£æ’­**
   ```cpp
   if (size > 4 && total_kps < 5000) {
       // keypoint å°‘ï¼Œå»£æ’­ Pyramid æ›´åˆ’ç®—
       broadcast_pyramid();
   }
   ```

2. **éé˜»å¡é€šè¨Š**
   ```cpp
   MPI_Isend / MPI_Irecv  // é‡ç–Šè¨ˆç®—èˆ‡é€šè¨Š
   ```

3. **SIMD å„ªåŒ–**
   ```cpp
   #pragma omp simd
   for (int k = 0; k < size; k++) {
       sum_val += img[y][x+k] * kernel[k];
   }
   ```

## ğŸ¯ é æœŸæ€§èƒ½æå‡

### å°æ¯”ä¹‹å‰ï¼ˆåªç”¨ rank 0ï¼‰

| æ¸¬è³‡ | ä¹‹å‰(rank 0) | å„ªåŒ–å¾Œ(n=4) | åŠ é€Ÿæ¯” |
|------|-------------|------------|--------|
| 01   | 13-47ç§’     | ~3-5ç§’     | 3-10x  |
| 02   | 44ç§’        | ~10-15ç§’   | 3-4x   |
| å¤§åœ– | ä¸ç©©å®š      | ç©©å®š       | ç©©å®š   |

### æ€§èƒ½ç©©å®šæ€§

**ä¹‹å‰**ï¼š13ç§’ ~ 47ç§’ï¼ˆ3.6x æ³¢å‹•ï¼‰
**å„ªåŒ–å¾Œ**ï¼šé æœŸ Â±10% æ³¢å‹•

**åŸå› **ï¼š
- âœ… æ‰€æœ‰ ranks å·¥ä½œï¼Œä¸ä¾è³´å–®ä¸€ç¯€é»
- âœ… è² è¼‰å¹³è¡¡ï¼Œé¿å…é•·å°¾æ•ˆæ‡‰
- âœ… å›ºå®šé…ç½®ï¼Œæ¸›å°‘é‹è¡Œæ™‚è®ŠåŒ–

é€™å€‹å„ªåŒ–ç‰ˆæœ¬æ‡‰è©²èƒ½åœ¨ä¼ºæœå™¨ä¸Šç²å¾—ç©©å®šä¸”é«˜æ•ˆçš„æ€§èƒ½ï¼ğŸš€
