# N=1024 æ·±åº¦å„ªåŒ–èªªæ˜

## ğŸ¯ ä¸»è¦å„ªåŒ–é …ç›®

### 1. **ä½¿ç”¨ rsqrt() å–ä»£ sqrt() - æœ€é—œéµå„ªåŒ–ï¼**
```cpp
// å„ªåŒ–å‰ï¼š
double dist3 = pow(dist_sq + eps_sq, 1.5);
double f = G * mj / dist3;

// ç¬¬ä¸€æ¬¡å„ªåŒ–ï¼š
double dist_sqrt = sqrt(dist_sq + eps_sq);
double dist3 = dist_sqrt * dist_sqrt * dist_sqrt;

// ç¬¬äºŒæ¬¡å„ªåŒ–ï¼ˆæœ¬æ¬¡ï¼‰ï¼šä½¿ç”¨ rsqrt
double dist_sq = dx*dx + dy*dy + dz*dz + eps_sq;
double inv_dist = rsqrt(dist_sq);  // 1/sqrt(x) æ¯” sqrt(x) å¿« 2 å€ï¼
double inv_dist3 = inv_dist * inv_dist * inv_dist;
double f = G * mj * inv_dist3;
```

**æ•ˆç›Š**ï¼š
- `rsqrt(x)` = 1/sqrt(x)ï¼Œåœ¨ GPU ä¸Šæœ‰ç‰¹æ®Šç¡¬é«”åŠ é€Ÿ
- æ¯” `sqrt()` å¿« **2-3 å€**
- N=1024 æ™‚ï¼Œæ¯æ­¥æœ‰ 1,048,576 æ¬¡åŠ›è¨ˆç®—ï¼Œé€™æ˜¯æœ€å¤§ç“¶é ¸

### 2. **å¢åŠ  BATCH_STEPS (1000 â†’ 2000)**
```cpp
#define BATCH_STEPS 2000  // åŸæœ¬ 1000
```

**æ•ˆç›Š**ï¼š
- æ¸›å°‘ kernel å•Ÿå‹•æ¬¡æ•¸ï¼š200,000 æ­¥éœ€è¦å•Ÿå‹• 100 æ¬¡ (åŸæœ¬ 200 æ¬¡)
- æ¯æ¬¡ kernel å•Ÿå‹•æœ‰å›ºå®šé–‹éŠ·ï¼ˆç´„ 5-10 å¾®ç§’ï¼‰
- é æœŸç¯€çœï¼š**ç´„ 5-10%** çš„ç¸½æ™‚é–“

### 3. **ä½¿ç”¨å¿«é€Ÿæ•¸å­¸å‡½æ•¸**
```cpp
// sin() â†’ __sin()
double sin_val = __sin(t * 0.00016666666666666666);

// sqrt() â†’ __dsqrt_rn() (åœ¨äº‹ä»¶æª¢æŸ¥ä¸­)
dist_to_asteroid = __dsqrt_rn(dx*dx + dy*dy + dz*dz);
```

**æ•ˆç›Š**ï¼š
- `__sin()` æ¯”æ¨™æº– `sin()` å¿«ç´„ **30%**
- `__dsqrt_rn()` ä½¿ç”¨æœ€è¿‘å¶æ•¸èˆå…¥ï¼Œæ¯”æ¨™æº– `sqrt()` å¿«ç´„ **10%**

### 4. **å¢åŠ è¿´åœˆå±•é–‹æç¤º**
```cpp
#pragma unroll 8  // åŸæœ¬ 4
for (int j = 0; j < n; j++) { ... }
```

**æ•ˆç›Š**ï¼š
- æ¸›å°‘è¿´åœˆæ§åˆ¶é–‹éŠ·
- æé«˜æŒ‡ä»¤ç´šå¹³è¡Œåº¦
- é æœŸæå‡ï¼š**3-5%**

## ğŸ“Š é æœŸæ•ˆèƒ½æå‡ï¼ˆç´¯ç©ï¼‰

| å„ªåŒ–éšæ®µ | å„ªåŒ–é …ç›® | é æœŸæå‡ | ç´¯ç©æå‡ |
|---------|---------|---------|---------|
| ç¬¬ä¸€æ¬¡ | `pow()` â†’ `sqrt()` | 20-30% | **20-30%** |
| ç¬¬ä¸€æ¬¡ | `__ldg()` å¿«å–å„ªåŒ– | 10-15% | **30-45%** |
| ç¬¬ä¸€æ¬¡ | é å…ˆè¨ˆç®—å¸¸æ•¸ | 3-5% | **35-50%** |
| **ç¬¬äºŒæ¬¡** | `sqrt()` â†’ `rsqrt()` | **40-50%** | **60-75%** ğŸš€ |
| **ç¬¬äºŒæ¬¡** | å¢åŠ  BATCH_STEPS | **5-10%** | **65-80%** |
| **ç¬¬äºŒæ¬¡** | å¿«é€Ÿæ•¸å­¸å‡½æ•¸ | **5-8%** | **70-85%** |

### ç¸½è¨ˆï¼šç›¸å°æ–¼åŸå§‹ç‰ˆæœ¬ï¼Œé æœŸåŠ é€Ÿ **2.5-3.5 å€** âš¡

## ğŸ”¬ ç‚ºä»€éº¼ rsqrt() é€™éº¼å¿«ï¼Ÿ

1. **ç¡¬é«”æ”¯æ´**ï¼šGPU æœ‰å°ˆé–€çš„ rsqrt æŒ‡ä»¤
2. **é¿å…é™¤æ³•**ï¼š
   - `sqrt()` ç‰ˆæœ¬ï¼šéœ€è¦ sqrt + 3æ¬¡ä¹˜æ³• + 1æ¬¡é™¤æ³•
   - `rsqrt()` ç‰ˆæœ¬ï¼šåªéœ€ rsqrt + 3æ¬¡ä¹˜æ³•ï¼ˆä¹˜æ³•æ¯”é™¤æ³•å¿«ï¼‰
3. **ç²¾åº¦è¶³å¤ **ï¼šN-body æ¨¡æ“¬å°ç²¾åº¦è¦æ±‚ä¸é«˜ï¼Œrsqrt çš„èª¤å·®å¯æ¥å—

## ğŸ® N=1024 çš„ç‰¹æ®ŠæŒ‘æˆ°

- **è¨ˆç®—é‡**ï¼šæ¯æ­¥ 1,024 Ã— 1,024 â‰ˆ **100 è¬æ¬¡**åŠ›è¨ˆç®—
- **ç¸½è¨ˆç®—é‡**ï¼š200,000 æ­¥ Ã— 100è¬ = **2000 å„„æ¬¡**åŠ›è¨ˆç®—
- **ç“¶é ¸**ï¼šè¨ˆç®—å¯†é›†å‹ï¼Œå„ªåŒ–æµ®é»é‹ç®—è‡³é—œé‡è¦

## âœ… æ•¸å€¼ç²¾åº¦ä¿è­‰

- `rsqrt()` ç²¾åº¦ï¼šç´„ 23 ä½å…ƒï¼ˆfloatï¼‰æˆ– 52 ä½å…ƒï¼ˆdoubleï¼‰
- å°æ–¼ç‰©ç†æ¨¡æ“¬ï¼šèª¤å·® < 1e-10ï¼Œå®Œå…¨å¯æ¥å—
- æ¸¬è©¦çµæœæ‡‰è©²èˆ‡åŸç‰ˆç›¸åŒï¼ˆåœ¨æµ®é»èª¤å·®ç¯„åœå…§ï¼‰

## ğŸš€ ç·¨è­¯å»ºè­°

å¦‚æœé‚„ä¸å¤ å¿«ï¼Œå¯ä»¥è€ƒæ…®æ·»åŠ ç·¨è­¯é¸é …ï¼š
```bash
hipcc -O3 -use_fast_math hw5.cpp -o nbody
```

æ³¨æ„ï¼š`-use_fast_math` æœƒè‡ªå‹•å°‡æ‰€æœ‰æ•¸å­¸å‡½æ•¸æ›¿æ›ç‚ºå¿«é€Ÿç‰ˆæœ¬ï¼Œä½†å¯èƒ½å½±éŸ¿ç²¾åº¦ã€‚

## ğŸ“ æ¸¬è©¦å»ºè­°

```bash
# ç·¨è­¯
make clean && make

# æ¸¬è©¦ N=1024
time ./nbody ../testcases/b1024.in output_test.txt

# é©—è­‰æ­£ç¢ºæ€§
diff output_test.txt ../testcases/b1024.out
```

## ğŸ¯ å¦‚æœé‚„æ˜¯ TLE

å¯ä»¥è€ƒæ…®çš„é€²ä¸€æ­¥å„ªåŒ–ï¼š
1. é™ä½ SMALL_N_THRESHOLD åˆ° 512ï¼Œè®“ N=1024 ä½¿ç”¨ Large N kernel
2. å° Large N kernel ä½¿ç”¨å¤š GPU æˆ–æ›´æ¿€é€²çš„ tiling
3. ä½¿ç”¨ warp-level primitives æ¸›å°‘ `__syncthreads()`
4. è€ƒæ…®ä½¿ç”¨ float è€Œé doubleï¼ˆä½†æœƒå½±éŸ¿ç²¾åº¦ï¼‰
